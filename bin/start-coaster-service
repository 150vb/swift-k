#!/bin/bash

# crash: Report a problem and exit
crash()
{
   MSG=$1
   echo ${MSG} >&2
   exit 1
}

# Start futuregrid workers
start-workers-futuregrid()
{
   PORT=$1
   EXECUTION_URL=http://localhost:$PORT

   if [ ! -d "$SWIFTVMBOOT_DIR" ] || [ ! -x "$SWIFTVMBOOT_DIR/bin/bootit.sh" ]; then
      crash "SWIFTVMBOOT_DIR incorrectly defined in coaster-service.conf"
   fi

   echo Starting virtual machines.. please wait
   $SWIFTVMBOOT_DIR/bin/bootit.sh
   SWIFTVMBOOT_OUTPUT=$SWIFTVMBOOT_DIR/output.json

   if [ ! -f "$SWIFTVMBOOT_OUTPUT" ]; then
      crash "Error: Swift VM output file $SWIFTVMBOOT_OUTPUT does not exist!"
   fi

   SWIFTVM_INSTANCES=`grep instance_id $SWIFTVMBOOT_OUTPUT |awk '{print $2}'|sed 's/\"//g;s/,//g;s/null//g'`
   echo $SWIFTVM_INSTANCES > .swiftvm_instances

   WORKER_HOSTS=`grep hostname $SWIFTVMBOOT_OUTPUT |awk '{print $2}'|sed 's/\"//g;s/,//g;s/null//g'`

   # Start worker script
   for MACHINE in $WORKER_HOSTS
   do
      # Enable ssh tunneling if needed
      if [ "$SSH_TUNNELING" == "yes" ]; then
         ssh -R *:$PORT:localhost:$PORT $WORKER_USERNAME@$MACHINE sleep 999 &
         echo $! >> $PID_FILE
      fi

      # Copy and start worker script
      scp $SWIFT_BIN/$WORKER $WORKER_USERNAME@$MACHINE:$WORKER_LOCATION > /dev/null 2>&1
      echo "Starting worker on $MACHINE"
      ssh $WORKER_USERNAME@$MACHINE "$WORKER_LOCATION/$WORKER $EXECUTION_URL $MACHINE $LOG_DIR" &
      echo $! >> $PID_FILE
   done
}

# Start SSH workers
start-workers-ssh()
{
   PORT=$1
   EXECUTION_URL=http://$IPADDR:$PORT
   if [ -z "$PORT" ]; then
      crash "start-workers-ssh: Port number not specified, giving up"
   fi

   if [ -n "$WORKER_RELAY_HOST" ]; then
      scp $SWIFT_BIN/$WORKER $WORKER_USERNAME@$WORKER_RELAY_HOST:/tmp > /dev/null 2>&1
   fi

   for MACHINE in $WORKER_HOSTS
   do
      # Enable ssh tunneling if needed
      if [ "$SSH_TUNNELING" == "yes" ]; then
         ssh -R *:$PORT:localhost:$PORT $WORKER_USERNAME@$MACHINE sleep 999 &
         echo $! >> $PID_FILE
      fi

      # Use a relay host
      if [ -n "$WORKER_RELAY_HOST" ]; then
         ssh $WORKER_USERNAME@$WORKER_RELAY_HOST ssh $MACHINE mkdir -p $WORKER_LOCATION > /dev/null 2>&1
         ssh $WORKER_USERNAME@$WORKER_RELAY_HOST "scp /tmp/$WORKER $WORKER_USERNAME@$MACHINE:$WORKER_LOCATION" > /dev/null 2>&1
         echo Starting worker on $MACHINE
         ssh $WORKER_USERNAME@$WORKER_RELAY_HOST ssh $WORKER_USERNAME@$MACHINE "WORKER_LOGGING_LEVEL=$WORKER_LOGGING_LEVEL $WORKER_LOCATION/$WORKER $EXECUTION_URL $MACHINE $WORKER_LOG_DIR" &
         echo $! >> $PID_FILE
      # Connect directly
      else
         ssh $WORKER_USERNAME@$MACHINE mkdir -p $WORKER_LOCATION > /dev/null 2>&1
         scp $SWIFT_BIN/$WORKER $WORKER_USERNAME@$MACHINE:$WORKER_LOCATION > /dev/null 2>&1
         echo Starting worker on $MACHINE
         ssh $WORKER_USERNAME@$MACHINE "$WORKER_LOCATION/$WORKER $EXECUTION_URL $MACHINE $LOG_DIR" &
         echo $! >> $PID_FILE
      fi
   done
   return 0
}

# Start local workers
start-workers-local()
{
   PORT=$1
   EXECUTION_URL=http://$IPADDR:$PORT
   if [ -z "$PORT" ]; then
      crash "start-workers-local: Port number not specified, giving up"
   fi
   echo Starting worker on local machine
   $WORKER $EXECUTION_URL LOCAL $LOG_DIR &
   echo $! >> $PID_FILE
   return 0
}

# Start cobalt workers
start-workers-cobalt()
{
  PORT=$1
  if [ -z "$PORT" ]; then
      crash "start-workers-cobalt: Port number not specified, giving up"
  fi
  EXECUTION_URL=http://$IPADDR:$PORT
  local TIMESTAMP=$(date "+%Y.%m%d.%H%M%S")
  local -Z 5 R=${RANDOM}
  ID="${TIMESTAMP}.${R}"
  echo cqsub -q ${QUEUE}   \
        -k zeptoos    \
        -t ${MAXTIME} \ # minutes
        -n ${NODES}   \
        --cwd ${LOGDIR} \
        -E ${LOGDIR}/cobalt.${$}.stderr \
        -o ${LOGDIR}/cobalt.${$}.stdout \
        -e "WORKER_LOGGING_LEVEL=DEBUG:ZOID_ENABLE_NAT=true" \
        $WORKER $EXECUTION_URL $ID $LOG_DIR

  echo $! >> $PID_FILE
  return 0
}

if [ ! -d "$HOME/.swift" ]; then
   mkdir -p "$HOME/.swift" || crash "Unable to create $HOME/.swift"
fi

PID_FILE="$HOME/.swift/.coaster-service-pids"
RUN_DIR=`pwd`

# Import settings
if [ -f "$RUN_DIR/coaster-service.conf" ]; then
   CONFIG_FILE="$RUN_DIR/coaster-service.conf"
elif [ -f "$HOME/.swift/coaster-service.conf" ]; then
   CONFIG_FILE="$HOME/.swift/coaster-service.conf"
elif [ -f "$(dirname $(readlink -f $0))/../etc/coaster-service.conf" ]; then
   CONFIG_FILE="$(dirname $(readlink -f $0))/../etc/coaster-service.conf"
else
   crash "Cannot find coaster-service.conf!"
fi

echo "start-coaster-service..."
echo "configuration: $CONFIG_FILE"

source $CONFIG_FILE

# Determine IP address to which workers should connect
if [ -z "$IPADDR" ]; then
   if [ "$SSH_TUNNELING" == "yes" ]; then
      IPADDR=localhost
   elif [ -x "/sbin/ifconfig" ]; then
      IPADDR=$( /sbin/ifconfig | grep 'inet addr' | grep -v 127.0.0.1 | cut -d ':' -f 2 | awk '{print $1}' |head -1)
   else
      crash "Unable to determine IP address of system. Please add to coaster-service.conf"
   fi
fi
echo Service address: $IPADDR

# Find swift
if [ ! -x "$SWIFT" ]; then
   SWIFT=`which swift`
   if [ ! -x "$SWIFT" ]; then
      crash "Unable to find swift! Please either add to your $PATH or specify the path in coaster-service.conf"
   fi
fi

SWIFT_BIN=`dirname $SWIFT`
WORKER=worker.pl

# Verify worker script is there
if [ ! -x "$SWIFT_BIN/$WORKER" ]; then
   crash "Error: Unable to find worker at $SWIFT_BIN/$WORKER!"
fi

# Try to create $LOG_DIR if needed, relative to $RUN_DIR
if [ ! -d "$RUN_DIR/$LOG_DIR" ]; then
   mkdir -p "$RUN_DIR/$LOG_DIR" > /dev/null 2>&1
   if [ ! -d "$RUN_DIR/$LOG_DIR" ]; then
      crash "Unable to make directory $RUN_DIR/$LOG_DIR!"
   fi
fi

# Set paths to log files
SWIFT_LOG="$RUN_DIR/$LOG_DIR"/swift.out
COASTER_LOG="$RUN_DIR/$LOG_DIR"/coaster.log

# Verify we can find coaster service
if [ ! -x "$SWIFT_BIN/coaster-service" ]; then
   crash "Unable to find $SWIFT_BIN/coaster-service!"
fi

# Create files for storing port info, if needed
if [ -z "$LOCAL_PORT" ]; then
   LOCAL_PORT_FILE=`mktemp`
fi

if [ -z "$SERVICE_PORT" ]; then
   SERVICE_PORT_FILE=`mktemp`
fi

# Check values in configuration file to determine how we should start coaster-service
echo Starting coaster-service
if [ -z "$SERVICE_PORT" ] && [ -z "$LOCAL_PORT" ]; then
   $SWIFT_BIN/coaster-service -nosec -portfile $SERVICE_PORT_FILE -localportfile $LOCAL_PORT_FILE -passive > $COASTER_LOG 2>&1 &
elif [ -n "$SERVICE_PORT" ] && [ -z "$LOCAL_PORT" ]; then
   $SWIFT_BIN/coaster-service -nosec -port $SERVICE_PORT -localportfile $LOCAL_PORT_FILE -passive > $COASTER_LOG 2>&1 &
elif [ -z "$SERVICE_PORT" ] && [ -n "$LOCAL_PORT" ]; then
   $SWIFT_BIN/coaster-service -nosec -portfile $SERVICE_PORT_FILE --localport $LOCAL_PORT -passive > $COASTER_LOG 2>&1 &
elif [ -n  "$SERVICE_PORT" ] && [ -n "$LOCAL_PORT" ]; then
   $SWIFT_BIN/coaster-service -nosec -port $SERVICE_PORT -localport $LOCAL_PORT -passive > $COASTER_LOG 2>&1 &
else
   crash "Unknown SERVICE_PORT type specified!"
fi

echo $! > $PID_FILE
sleep 5

# Determine SERVICE_PORT
if [ -z "$SERVICE_PORT" ]; then
   if [ ! -f "$SERVICE_PORT_FILE" ]; then
      crash "Unable to determine SERVICE_PORT!"
   fi
   SERVICE_PORT=`cat $SERVICE_PORT_FILE`
   rm $SERVICE_PORT_FILE
fi

# Determine LOCAL_PORT
if [ -z "$LOCAL_PORT" ]; then
   if [ ! -f "$LOCAL_PORT_FILE" ]; then
      crash "Unable to determine LOCAL_PORT!"
   fi
   LOCAL_PORT=`cat $LOCAL_PORT_FILE`
   rm $LOCAL_PORT_FILE
fi

echo Service port: $SERVICE_PORT
echo Local port: $LOCAL_PORT

# Start workers
case $WORKER_MODE in
   ssh)
      start-workers-ssh $LOCAL_PORT
      ;;
   local)
      start-workers-local $LOCAL_PORT
      ;;
   cobalt)
      start-workers-cobalt $LOCAL_PORT
      ;;
   futuregrid)
      start-workers-futuregrid $LOCAL_PORT
      ;;
   *)
      crash "Unknown WORKER_MODE. Please modify coaster-service.conf"
      ;;
esac

# Generate sites.xml
export EXECUTION_URL="http://$IPADDR:$SERVICE_PORT"
echo Generating sites.xml
if [ -f "gensites.template" ]; then
   gensites `cat gensites.template` -p $CONFIG_FILE > $RUN_DIR/sites.xml
else
   gensites persistent-coasters -p $CONFIG_FILE > $RUN_DIR/sites.xml
fi

# Generate config file
if [ "$SHARED_FILESYSTEM" == "no" ]; then
echo Generating config file
cat > $RUN_DIR/cf << EOF
use.provider.staging=true
wrapperlog.always.transfer=false
execution.retries=0
provider.staging.pin.swiftfiles=false
sitedir.keep=true
EOF
fi

# Local Variables:
# tab-width: 3
# sh-basic-offset: 3
# End:
