#!/bin/bash

# Verify an argument is not null
verify_not_null()
{
   argname=$1; shift
   if [ _$1 != _ ]; then
      return 0;
   else
      echo $0: value for $argname can not be null
      exit 1
   fi
}

# Parse command line arguments
args=""
script=""
while [ $# -gt 0 ]
do
   case "$1" in
      -site|-sites|-s) SITES=$2; verify_not_null sites $SITES; shift ;;
      *) if [ -z "$args" ]; then script="$1"
         else args+="$1"
         fi ;;
   esac
   shift
done

# Create run directory
rundir=$( echo run??? | sed -e 's/^.*run//' | awk '{ printf("run%03d\n", $1+1)}' )
mkdir $rundir

# Create sites.xml
IFS=","
echo "<config>" > $rundir/sites.xml
for site in $SITES
do
   gensites -l $site >> $rundir/sites.xml
done
echo "</config>" >> $rundir/sites.xml

# tc.data
if [ -f "tc.data" ]; then
   cp tc.data $rundir
fi

# Swift script
if [ -f "$script" ]; then 
   cp $script $rundir
fi

# Run
cd $rundir
time swift -sites.file sites.xml -tc.file tc.data $script $args 2>&1 | tee swift.out
