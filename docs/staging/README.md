Data flow and staging methods
=============================

Overview
--------

The execution components involved in a Swift workflow are the client, the swift
service and the workers. The client is the program that executes the workflow
described in a swift script and is invoked by the swift command. The service
may be started separately or automatically by the swift client and is responsible
for provisioning resources from clouds, clusters or HPC systems. The workers are
launched by the swift-service and are responsible for controlling the execution
of the user's application on the compute nodes.

Different clusters, HPC systems, and cloud vendors may have shared file-systems,
varying network characteristics and local-disks available which can be utilized
differently to marshal data efficiently within a workflow. Data flow refers to
this movement of data within a workflow. On distributed systems with varying
levels of shared resources, the Swift client and service coordinates the flow of
data among the worker-nodes such that the data required for computation is available
to the worker prior to the execution of the users's application as well as ensuring
that the computed results are captured once tasks run to completion.

There are 6 different staging methods that are supported by Swift. They are:

 * Local
 * Direct
 * Wrapper
 * Swift
 * Shared-fs
 * Service-local

These staging methods are explained in detail in the following sections.

Staging method : local
----------------------

![Local staging](/figs/local_staging.pdf)

Summary
^^^^^^^

The local staging method is designed for shared-nothing architectures such as
clusters and clouds with no shared file-systems. The data originates on the
node where the client runs and all data transfers are done over the network.
The client and service need not be on the same machine, which allows a client
running on a local workstation to channel data through a service on the
headnode of a Cluster1 to compute nodes provisioned from Cluster1.
The is the default file staging method as this works on all computational
resources. Since all the data is transferred via the swift-service the network
bandwidth of the service could bottleneck the data flow. Similarly if the swift
client is running remotely, the network links between the client and the service
could potentially become a bottleneck for large volumes of data.

When to use this mode
^^^^^^^^^^^^^^^^^^^^^

The data volumes that need to be transferred to and from the workers to the client are

Example configs
^^^^^^^^^^^^^^^

-----
sites: midway
site.midway {
    execution {
        type: "coaster"
        URL: "swift.rcc.uchicago.edu"
        jobManager: "ssh-cl:slurm"  # Client connects remotely to the login node.
        options {
            nodeGranularity: 1
            maxNodesPerJob: 1
            jobQueue: "sandyb"
            maxJobs: 1
            tasksPerNode: 1
            maxJobTime: "00:08:20"
        }
    }
    staging: "local"
    workDirectory: "/tmp/"${env.USER}
    app.date {
        executable: "/bin/date"
        maxWallTime: "00:05:00"
    }
}
-----


Analysing logs
^^^^^^^^^^^^^^
TODO

Performance
^^^^^^^^^^^
All data-flow is over the network in this staging method and as a result, larger
data volumes can impact performance adversely. The entire data flow must go through
the nodes on which the client and service are running and the bandwidth limitations
of that node must be taken into account.

When several small files are involved, or with sufficiently large files, the
filesystem on the client node can become a bottleneck.

Notes:
^^^^^^

When running using local coasters (local instead of ssh-cl), the client and service run on the same node.



Staging method : Direct
-----------------------

image:figs/direct_staging.pdf[]

image:figs/direct_staging_scratch.pdf[]

Summary
^^^^^^^
The direct staging mode is designed for computational resources with shared-filesystems.
This mode requires that a shared filesystem such as NFS, Lustre, or even FUSE-mounted-S3
is mounted across the nodes where the client, service, and the workers are executing.
While sandbox directories are created for the individual task executions, the tasks
themselves will receive absolute paths for the input and output files. For applications
that are IO bound, writing directly to the shared-filesystem can adversely affect the
shared filesystem performance. To avoid this there is an option to specify a “scratch”
folder on a local disk on the compute nodes.

When to use this mode
^^^^^^^^^^^^^^^^^^^^^

Large volumes of data are either consumed or generated by the application and a shared
-filesystem is available across the nodes. Given the volume of data and the network
capacity of the headnode, using the network to transfer data to the compute nodes might
be sub-optimal.

Another scenario is when the shared-filesystem is sensitive to creation and deletion
of small files and directories. The swift workers create a sandbox directory for each
task, which is (3 : TODO:confirm this with Mihael) levels deep. Using the direct mode
with the workDirectory on a local disk (say /tmp) could avoid the overhead from swift's
mechanisms for sandboxing tasks.

Example configs
^^^^^^^^^^^^^^^

The following is an example for the direct staging mode.
Staging method is set to “direct”
workDirectory may be set to the shared filesystem or a local filesystem.

-----
sites: midway

site.midway {
    execution {
        type: "coaster"
        URL: "swift.rcc.uchicago.edu"
        jobManager: "local:slurm"
        options {
            nodeGranularity: 1
            maxNodesPerJob: 1
            jobQueue: "sandyb"
            maxJobs: 1
            tasksPerNode: 1
            maxJobTime: "00:08:20"
        }
    }
    staging: direct
    workDirectory: "/tmp/"${env.USER}"/swiftwork"
    app.bash {
        executable: "/bin/bash"
        maxWallTime: "00:05:00"
    }
}
-----

The following is an example for the direct staging mode.
Staging method is set to “direct”
workDirectory may be set to the shared filesystem or a local filesystem.
Scratch is set to a directory on the local disks of the workers. The input/output files
are copied to this directory and the user tasks are presented with paths which point to
files in this directory. The workers will copy output files from the scratch directory to
the shared-filesystem paths for the outputs.

-----
sites: midway

site.midway {
    execution {
        type: "coaster"
        URL: "swift.rcc.uchicago.edu"
        jobManager: "local:slurm"
        options {
            nodeGranularity: 1
            maxNodesPerJob: 1
            jobQueue: "sandyb"
            maxJobs: 1
            tasksPerNode: 1
            maxJobTime: "00:08:20"
        }
    }
    staging: direct
    workDirectory: "/tmp/"${env.USER}"/swiftwork"
    scratch: "/scratch/local/"${env.USER}"/work/"
    app.bash {
        executable: "/bin/bash"
        maxWallTime: "00:05:00"
    }
}

TCPPortRange: "50000,51000"
lazyErrors: false
executionRetries: 0
keepSiteDir: true
providerStagingPinSwiftFiles: false
alwaysTransferWrapperLog: true
-----

Notes:
^^^^^^

TODO : Details of the filename behavior in apps and within swiftscript body.

When this configuration is used, the worker copies the input files from the shared-filesystem to the scratch directory, and the user application will get the path to the file on scratch when the filename(<file_variable>) and it's shorthand @<file_variable> primitives are used in the app definition. The filename and @ primitives when used outside of the app definitions will point at the files on the shared-filesystem.

Analysing logs
^^^^^^^^^^^^^^

Performance
^^^^^^^^^^^


Staging method : Swift
----------------------

image:figs/swift_staging.pdf

Summary
^^^^^^^
Swift staging, invovles the client accessing file over a supported method like
ssh or a local-filesystem access, and making the inputs available to the workers
over a work-directory on a shared filesystem.

When to use this mode
^^^^^^^^^^^^^^^^^^^^^

Example configs
^^^^^^^^^^^^^^^

Analysing logs
^^^^^^^^^^^^^^

Performance
^^^^^^^^^^^


Staging method : Wrapper
------------------------

image:figs/wrapper_staging.pdf

Summary
^^^^^^^

When to use this mode
^^^^^^^^^^^^^^^^^^^^^

Example configs
^^^^^^^^^^^^^^^

Analysing logs
^^^^^^^^^^^^^^

Performance
^^^^^^^^^^^