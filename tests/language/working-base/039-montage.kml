<project>
  <import file="sys.xml"/>
  <import file="scheduler.xml"/>
  <import file="rlog.xml"/>
  <import file="vdl.k"/>
  <types>
    <xs:schema targetNamespace="http://www.griphyn.org/2006/08/vdl" xmlns="http://www.griphyn.org/2006/08/vdl" xmlns:xs="http://www.w3.org/2001/XMLSchema">
      <xs:simpleType name="Image">
        <xs:restriction base="xs:string"/>
      </xs:simpleType>
      <xs:simpleType name="Header">
        <xs:restriction base="xs:string"/>
      </xs:simpleType>
      <xs:simpleType name="Table">
        <xs:restriction base="xs:string"/>
      </xs:simpleType>
      <xs:complexType name="DiffStruct">
        <xs:sequence>
          <xs:element name="cntr1" type="xs:int"/>
          <xs:element name="cntr2" type="xs:int"/>
          <xs:element name="plus" type="Image"/>
          <xs:element name="minus" type="Image"/>
          <xs:element name="diff" type="Image"/>
        </xs:sequence>
      </xs:complexType>
      <xs:simpleType name="TxtFile">
        <xs:restriction base="xs:string"/>
      </xs:simpleType>
      <xs:simpleType name="JPEG">
        <xs:restriction base="xs:string"/>
      </xs:simpleType>
    </xs:schema>
  </types>
  <element name="mProjectPP" arguments="projectedImage,projectedArea,rawImage,template">
    <vdl:typecheck argname="projectedImage" var="{projectedImage}" type="Image"/>
    <vdl:typecheck argname="projectedArea" var="{projectedArea}" type="Image"/>
    <vdl:typecheck argname="rawImage" var="{rawImage}" type="Image"/>
    <vdl:typecheck argname="template" var="{template}" type="Header"/>
    <vdl:execute>
      <vdl:tr>mProjectPP</vdl:tr>
      <vdl:stagein var="{rawImage}"/>
      <vdl:stagein var="{template}"/>
      <vdl:stageout var="{projectedImage}"/>
      <vdl:stageout var="{projectedArea}"/>
      <vdl:arguments>
        <string>-X</string>	
        <vdl:filename var="{rawImage}"/>	
        <vdl:filename var="{projectedImage}"/>	
        <vdl:filename var="{template}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{projectedImage}"/>
    <vdl:closedataset var="{projectedArea}"/>
  </element>

  <element name="mProjectPPBatch" arguments="projectedImages,projectedAreas,rawImages,template">
    <vdl:typecheck argname="projectedImages" var="{projectedImages}" type="Image" isArray="true"/>
    <vdl:typecheck argname="projectedAreas" var="{projectedAreas}" type="Image" isArray="true"/>
    <vdl:typecheck argname="rawImages" var="{rawImages}" type="Image" isArray="true"/>
    <vdl:typecheck argname="template" var="{template}" type="Header"/>
    <set name="img">
      <vdl:new type="Image" dbgname="img">
        <vdl:mapping descriptor="concurrent_mapper">
          <vdl:parameter name="prefix" value="img-7a9596e8-2d86-4db9-9e65-416f3212c567"/>
        </vdl:mapping>
      </vdl:new>
    </set>
    <parallel>
      <parallelFor name="$">
        <vdl:getarrayfieldvalue path="" var="{rawImages}"/>
          <set names="i, img">
            <each items="{$}"/>
          </set>
          <set name="projImg">
            <vdl:new type="Image" dbgname="projImg">
              <vdl:mapping descriptor="regexp_mapper">
                <vdl:parameter name="source">
                  <vdl:filename var="{img}"/>
                </vdl:parameter>
                <vdl:parameter name="match">
                  <string>.*\/(.*)</string>
                </vdl:parameter>
                <vdl:parameter name="transform">
                  <string>proj_\1</string>
                </vdl:parameter>
                <vdl:parameter name="input" value="false"/>
              </vdl:mapping>
            </vdl:new>
          </set>
          <set name="areaImg">
            <vdl:new type="Image" dbgname="areaImg">
              <vdl:mapping descriptor="regexp_mapper">
                <vdl:parameter name="source">
                  <vdl:filename var="{projImg}"/>
                </vdl:parameter>
                <vdl:parameter name="match">
                  <string>(.*)\.(.*)</string>
                </vdl:parameter>
                <vdl:parameter name="transform">
                  <string>\1_area.\2</string>
                </vdl:parameter>
                <vdl:parameter name="input" value="false"/>
              </vdl:mapping>
            </vdl:new>
          </set>
          <vdl:assign dpath="[i]" dvar="{projectedImages}">
            <argument name="svar">
          	<variable>projImg</variable>
            </argument>
          </vdl:assign>
          <vdl:assign dpath="[i]" dvar="{projectedAreas}">
            <argument name="svar">
          	<variable>areaImg</variable>
            </argument>
          </vdl:assign>
          <parallel>
            <mProjectPP>
              <parallel>
                <variable>projImg</variable>
                <variable>areaImg</variable>
                <variable>img</variable>
                <variable>template</variable>
              </parallel>
            </mProjectPP>
          </parallel>
      </parallelFor>
    </parallel>
    <vdl:closedataset var="{projectedImages}"/>
    <vdl:closedataset var="{projectedAreas}"/>
  </element>

  <element name="mOverlaps" arguments="diffsTbl,imagesTbl">
    <vdl:typecheck argname="diffsTbl" var="{diffsTbl}" type="Table"/>
    <vdl:typecheck argname="imagesTbl" var="{imagesTbl}" type="Table"/>
    <vdl:execute>
      <vdl:tr>mOverlaps</vdl:tr>
      <vdl:stagein var="{imagesTbl}"/>
      <vdl:stageout var="{diffsTbl}"/>
      <vdl:arguments>
        <vdl:filename var="{imagesTbl}"/>	
        <vdl:filename var="{diffsTbl}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{diffsTbl}"/>
  </element>

  <element name="mDiffFit" arguments="diffImage,statusFile,projectedImage1,projectedArea1,projectedImage2,projectedArea2,template">
    <vdl:typecheck argname="diffImage" var="{diffImage}" type="Image"/>
    <vdl:typecheck argname="statusFile" var="{statusFile}" type="TxtFile"/>
    <vdl:typecheck argname="projectedImage1" var="{projectedImage1}" type="Image"/>
    <vdl:typecheck argname="projectedArea1" var="{projectedArea1}" type="Image"/>
    <vdl:typecheck argname="projectedImage2" var="{projectedImage2}" type="Image"/>
    <vdl:typecheck argname="projectedArea2" var="{projectedArea2}" type="Image"/>
    <vdl:typecheck argname="template" var="{template}" type="Header"/>
    <vdl:execute>
      <vdl:tr>mDiffFit</vdl:tr>
      <vdl:stagein var="{projectedImage1}"/>
      <vdl:stagein var="{projectedArea1}"/>
      <vdl:stagein var="{projectedImage2}"/>
      <vdl:stagein var="{projectedArea2}"/>
      <vdl:stagein var="{template}"/>
      <vdl:stageout var="{diffImage}"/>
      <vdl:stageout var="{statusFile}"/>
      <vdl:arguments>
        <string>-s</string>	
        <vdl:filename var="{statusFile}"/>	
        <vdl:filename var="{projectedImage1}"/>	
        <vdl:filename var="{projectedImage2}"/>	
        <vdl:filename var="{diffImage}"/>	
        <vdl:filename var="{template}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{diffImage}"/>
    <vdl:closedataset var="{statusFile}"/>
  </element>

  <element name="mDiffFitBatch" arguments="diffImages,statusFiles,diffsTbl,template">
    <vdl:typecheck argname="diffImages" var="{diffImages}" type="Image" isArray="true"/>
    <vdl:typecheck argname="statusFiles" var="{statusFiles}" type="TxtFile" isArray="true"/>
    <vdl:typecheck argname="diffsTbl" var="{diffsTbl}" type="Table"/>
    <vdl:typecheck argname="template" var="{template}" type="Header"/>
    <set name="diffs">
      <vdl:new type="DiffStruct" dbgname="diffs" isArray="true">
        <vdl:mapping descriptor="csv_mapper">
          <vdl:parameter name="file">
            <vdl:filename var="{diffsTbl}"/>
          </vdl:parameter>
          <vdl:parameter name="skip">
            <string>1</string>
          </vdl:parameter>
          <vdl:parameter name="hdelim">
            <string> |</string>
          </vdl:parameter>
          <vdl:parameter name="input" value="true"/>
        </vdl:mapping>
      </vdl:new>
    </set>
    <parallel>
      <parallelFor name="$">
        <vdl:getarrayfieldvalue path="" var="{diffs}"/>
          <set names="i, d">
            <each items="{$}"/>
          </set>
          <set name="image1">
            <vdl:new type="Image" dbgname="image1">
              <argument name="value">
                <vdl:getfield var="{d}" path="plus"/>
              </argument>
            </vdl:new>
          </set>
          <set name="area1">
            <vdl:new type="Image" dbgname="area1">
              <vdl:mapping descriptor="regexp_mapper">
                <vdl:parameter name="source">
                  <vdl:filename var="{image1}"/>
                </vdl:parameter>
                <vdl:parameter name="match">
                  <string>(.*)\.(.*)</string>
                </vdl:parameter>
                <vdl:parameter name="transform">
                  <string>\1_area.\2</string>
                </vdl:parameter>
                <vdl:parameter name="input" value="true"/>
              </vdl:mapping>
            </vdl:new>
          </set>
          <set name="image2">
            <vdl:new type="Image" dbgname="image2">
              <argument name="value">
                <vdl:getfield var="{d}" path="minus"/>
              </argument>
            </vdl:new>
          </set>
          <set name="area2">
            <vdl:new type="Image" dbgname="area2">
              <vdl:mapping descriptor="regexp_mapper">
                <vdl:parameter name="source">
                  <vdl:filename var="{image2}"/>
                </vdl:parameter>
                <vdl:parameter name="match">
                  <string>(.*)\.(.*)</string>
                </vdl:parameter>
                <vdl:parameter name="transform">
                  <string>\1_area.\2</string>
                </vdl:parameter>
                <vdl:parameter name="input" value="true"/>
              </vdl:mapping>
            </vdl:new>
          </set>
          <set name="diffImg">
            <vdl:new type="Image" dbgname="diffImg">
              <vdl:mapping descriptor="fixed_mapper">
                <vdl:parameter name="file">
                  <vdl:filename path="diff" var="{d}"/>
                </vdl:parameter>
                <vdl:parameter name="input" value="false"/>
              </vdl:mapping>
            </vdl:new>
          </set>
          <set name="statusFile">
            <vdl:new type="TxtFile" dbgname="statusFile">
              <vdl:mapping descriptor="regexp_mapper">
                <vdl:parameter name="source">
                  <vdl:filename var="{diffImg}"/>
                </vdl:parameter>
                <vdl:parameter name="match">
                  <string>diff(.*)fits</string>
                </vdl:parameter>
                <vdl:parameter name="transform">
                  <string>fit\1txt</string>
                </vdl:parameter>
                <vdl:parameter name="input" value="false"/>
              </vdl:mapping>
            </vdl:new>
          </set>
          <vdl:assign dpath="[i]" dvar="{diffImages}">
            <argument name="svar">
          	<variable>diffImg</variable>
            </argument>
          </vdl:assign>
          <vdl:assign dpath="[i]" dvar="{statusFiles}">
            <argument name="svar">
          	<variable>statusFile</variable>
            </argument>
          </vdl:assign>
          <parallel>
            <mDiffFit>
              <parallel>
                <variable>diffImg</variable>
                <variable>statusFile</variable>
                <variable>image1</variable>
                <variable>area1</variable>
                <variable>image2</variable>
                <variable>area2</variable>
                <variable>template</variable>
              </parallel>
            </mDiffFit>
          </parallel>
      </parallelFor>
    </parallel>
    <vdl:closedataset var="{diffImages}"/>
    <vdl:closedataset var="{statusFiles}"/>
  </element>

  <element name="mStatTbl" arguments="statusFilesTbl,diffsTbl">
    <vdl:typecheck argname="statusFilesTbl" var="{statusFilesTbl}" type="Table"/>
    <vdl:typecheck argname="diffsTbl" var="{diffsTbl}" type="Table"/>
    <vdl:execute>
      <vdl:tr>mStatTbl</vdl:tr>
      <vdl:stagein var="{diffsTbl}"/>
      <vdl:stageout var="{statusFilesTbl}"/>
      <vdl:arguments>
        <vdl:filename var="{diffsTbl}"/>	
        <vdl:filename var="{statusFilesTbl}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{statusFilesTbl}"/>
  </element>

  <element name="mConcatFit" arguments="fitsTbl,statusFilesTbl,statusFiles,statusDir">
    <vdl:typecheck argname="fitsTbl" var="{fitsTbl}" type="Table"/>
    <vdl:typecheck argname="statusFilesTbl" var="{statusFilesTbl}" type="Table"/>
    <vdl:typecheck argname="statusFiles" var="{statusFiles}" type="TxtFile" isArray="true"/>
    <vdl:typecheck argname="statusDir" var="{statusDir}" type="string"/>
    <vdl:execute>
      <vdl:tr>mConcatFit</vdl:tr>
      <vdl:stagein var="{statusFilesTbl}"/>
      <vdl:stagein var="{statusFiles}"/>
      <vdl:stagein var="{statusDir}"/>
      <vdl:stageout var="{fitsTbl}"/>
      <vdl:arguments>
        <vdl:filename var="{statusFilesTbl}"/>	
        <vdl:filename var="{fitsTbl}"/>	
        <vdl:getfieldvalue var="{statusDir}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{fitsTbl}"/>
  </element>

  <element name="mBgModel" arguments="correctionsTbl,projectedImagesTbl,fitsTbl">
    <vdl:typecheck argname="correctionsTbl" var="{correctionsTbl}" type="Table"/>
    <vdl:typecheck argname="projectedImagesTbl" var="{projectedImagesTbl}" type="Table"/>
    <vdl:typecheck argname="fitsTbl" var="{fitsTbl}" type="Table"/>
    <vdl:execute>
      <vdl:tr>mBgModel</vdl:tr>
      <vdl:stagein var="{projectedImagesTbl}"/>
      <vdl:stagein var="{fitsTbl}"/>
      <vdl:stageout var="{correctionsTbl}"/>
      <vdl:arguments>
        <vdl:filename var="{projectedImagesTbl}"/>	
        <vdl:filename var="{fitsTbl}"/>	
        <vdl:filename var="{correctionsTbl}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{correctionsTbl}"/>
  </element>

  <element name="mBackground" arguments="correctedImage,correctedArea,projectedImage,projectedArea,projectedImagesTbl,correctionsTbl">
    <vdl:typecheck argname="correctedImage" var="{correctedImage}" type="Image"/>
    <vdl:typecheck argname="correctedArea" var="{correctedArea}" type="Image"/>
    <vdl:typecheck argname="projectedImage" var="{projectedImage}" type="Image"/>
    <vdl:typecheck argname="projectedArea" var="{projectedArea}" type="Image"/>
    <vdl:typecheck argname="projectedImagesTbl" var="{projectedImagesTbl}" type="Table"/>
    <vdl:typecheck argname="correctionsTbl" var="{correctionsTbl}" type="Table"/>
    <vdl:execute>
      <vdl:tr>mBackground</vdl:tr>
      <vdl:stagein var="{projectedImage}"/>
      <vdl:stagein var="{projectedArea}"/>
      <vdl:stagein var="{projectedImagesTbl}"/>
      <vdl:stagein var="{correctionsTbl}"/>
      <vdl:stageout var="{correctedImage}"/>
      <vdl:stageout var="{correctedArea}"/>
      <vdl:arguments>
        <string>-t</string>	
        <vdl:filename var="{projectedImage}"/>	
        <vdl:filename var="{correctedImage}"/>	
        <vdl:filename var="{projectedImagesTbl}"/>	
        <vdl:filename var="{correctionsTbl}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{correctedImage}"/>
    <vdl:closedataset var="{correctedArea}"/>
  </element>

  <element name="mBackgroundBatch" arguments="correctedImages,correctedAreas,projectedImages,projectedAreas,projectedImagesTbl,correctionsTbl">
    <vdl:typecheck argname="correctedImages" var="{correctedImages}" type="Image" isArray="true"/>
    <vdl:typecheck argname="correctedAreas" var="{correctedAreas}" type="Image" isArray="true"/>
    <vdl:typecheck argname="projectedImages" var="{projectedImages}" type="Image" isArray="true"/>
    <vdl:typecheck argname="projectedAreas" var="{projectedAreas}" type="Image" isArray="true"/>
    <vdl:typecheck argname="projectedImagesTbl" var="{projectedImagesTbl}" type="Table"/>
    <vdl:typecheck argname="correctionsTbl" var="{correctionsTbl}" type="Table"/>

    <parallel>
      <parallelFor name="$">
        <vdl:getarrayfieldvalue path="" var="{projectedImages}"/>
          <set names="i, projImg">
            <each items="{$}"/>
          </set>
          <set name="projArea">
            <vdl:new type="Image" dbgname="projArea">
              <argument name="value">
                <vdl:getfield var="{projectedAreas}">
                  <argument name="path">
                    <concat>
                      <string>[i]</string>
                    </concat>
                  </argument>
                </vdl:getfield>  
              </argument>
            </vdl:new>
          </set>
          <set name="corrImg">
            <vdl:new type="Image" dbgname="corrImg">
              <vdl:mapping descriptor="regexp_mapper">
                <vdl:parameter name="source">
                  <vdl:filename var="{projImg}"/>
                </vdl:parameter>
                <vdl:parameter name="match">
                  <string>proj_(.*)</string>
                </vdl:parameter>
                <vdl:parameter name="transform">
                  <string>corr_\1</string>
                </vdl:parameter>
                <vdl:parameter name="input" value="false"/>
              </vdl:mapping>
            </vdl:new>
          </set>
          <set name="corrArea">
            <vdl:new type="Image" dbgname="corrArea">
              <vdl:mapping descriptor="regexp_mapper">
                <vdl:parameter name="source">
                  <vdl:filename var="{corrImg}"/>
                </vdl:parameter>
                <vdl:parameter name="match">
                  <string>(.*)\.(.*)</string>
                </vdl:parameter>
                <vdl:parameter name="transform">
                  <string>\1_area.\2</string>
                </vdl:parameter>
                <vdl:parameter name="input" value="false"/>
              </vdl:mapping>
            </vdl:new>
          </set>
          <vdl:assign dpath="[i]" dvar="{correctedImages}">
            <argument name="svar">
          	<variable>corrImg</variable>
            </argument>
          </vdl:assign>
          <vdl:assign dpath="[i]" dvar="{correctedAreas}">
            <argument name="svar">
          	<variable>corrArea</variable>
            </argument>
          </vdl:assign>
          <parallel>
            <mBackground>
              <parallel>
                <variable>corrImg</variable>
                <variable>corrArea</variable>
                <variable>projImg</variable>
                <variable>projArea</variable>
                <variable>projectedImagesTbl</variable>
                <variable>correctionsTbl</variable>
              </parallel>
            </mBackground>
          </parallel>
      </parallelFor>
    </parallel>
    <vdl:closedataset var="{correctedImages}"/>
    <vdl:closedataset var="{correctedAreas}"/>
  </element>

  <element name="mImgtbl" arguments="imagesTbl,imageDir,images">
    <vdl:typecheck argname="imagesTbl" var="{imagesTbl}" type="Table"/>
    <vdl:typecheck argname="imageDir" var="{imageDir}" type="string"/>
    <vdl:typecheck argname="images" var="{images}" type="Image" isArray="true"/>
    <vdl:execute>
      <vdl:tr>mImgtbl</vdl:tr>
      <vdl:stagein var="{imageDir}"/>
      <vdl:stagein var="{images}"/>
      <vdl:stageout var="{imagesTbl}"/>
      <vdl:arguments>
        <vdl:getfieldvalue var="{imageDir}"/>	
        <vdl:filename var="{imagesTbl}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{imagesTbl}"/>
  </element>

  <element name="mImgtbl_t" arguments="newImagesTbl,imageDir,images,oldImagesTbl">
    <vdl:typecheck argname="newImagesTbl" var="{newImagesTbl}" type="Table"/>
    <vdl:typecheck argname="imageDir" var="{imageDir}" type="string"/>
    <vdl:typecheck argname="images" var="{images}" type="Image" isArray="true"/>
    <vdl:typecheck argname="oldImagesTbl" var="{oldImagesTbl}" type="Table"/>
    <vdl:execute>
      <vdl:tr>mImgtbl</vdl:tr>
      <vdl:stagein var="{imageDir}"/>
      <vdl:stagein var="{images}"/>
      <vdl:stagein var="{oldImagesTbl}"/>
      <vdl:stageout var="{newImagesTbl}"/>
      <vdl:arguments>
        <vdl:getfieldvalue var="{imageDir}"/>	
        <string>-t</string>	
        <vdl:filename var="{oldImagesTbl}"/>	
        <vdl:filename var="{newImagesTbl}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{newImagesTbl}"/>
  </element>

  <element name="mAdd" arguments="mosaic,mosaicArea,imagesTbl,template,images,imageAreas">
    <vdl:typecheck argname="mosaic" var="{mosaic}" type="Image"/>
    <vdl:typecheck argname="mosaicArea" var="{mosaicArea}" type="Image"/>
    <vdl:typecheck argname="imagesTbl" var="{imagesTbl}" type="Table"/>
    <vdl:typecheck argname="template" var="{template}" type="Header"/>
    <vdl:typecheck argname="images" var="{images}" type="Image" isArray="true"/>
    <vdl:typecheck argname="imageAreas" var="{imageAreas}" type="Image" isArray="true"/>
    <vdl:execute>
      <vdl:tr>mAdd</vdl:tr>
      <vdl:stagein var="{imagesTbl}"/>
      <vdl:stagein var="{template}"/>
      <vdl:stagein var="{images}"/>
      <vdl:stagein var="{imageAreas}"/>
      <vdl:stageout var="{mosaic}"/>
      <vdl:stageout var="{mosaicArea}"/>
      <vdl:arguments>
        <string>-e</string>	
        <vdl:filename var="{imagesTbl}"/>	
        <vdl:filename var="{template}"/>	
        <vdl:filename var="{mosaic}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{mosaic}"/>
    <vdl:closedataset var="{mosaicArea}"/>
  </element>

  <element name="mShrink" arguments="shrunkImage,image,factor">
    <vdl:typecheck argname="shrunkImage" var="{shrunkImage}" type="Image"/>
    <vdl:typecheck argname="image" var="{image}" type="Image"/>
    <vdl:typecheck argname="factor" var="{factor}" type="float"/>
    <vdl:execute>
      <vdl:tr>mShrink</vdl:tr>
      <vdl:stagein var="{image}"/>
      <vdl:stagein var="{factor}"/>
      <vdl:stageout var="{shrunkImage}"/>
      <vdl:arguments>
        <vdl:filename var="{image}"/>	
        <vdl:filename var="{shrunkImage}"/>	
        <vdl:getfieldvalue var="{factor}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{shrunkImage}"/>
  </element>

  <element name="mJPEG" arguments="jpeg,image">
    <vdl:typecheck argname="jpeg" var="{jpeg}" type="JPEG"/>
    <vdl:typecheck argname="image" var="{image}" type="Image"/>
    <vdl:execute>
      <vdl:tr>mJPEG</vdl:tr>
      <vdl:stagein var="{image}"/>
      <vdl:stageout var="{jpeg}"/>
      <vdl:arguments>
        <string>-ct</string>	
        <string>1</string>	
        <string>-gray</string>	
        <vdl:filename var="{image}"/>	
        <string>-1.5s</string>	
        <string>60s</string>	
        <string>gaussian</string>	
        <string>-out</string>	
        <vdl:filename var="{jpeg}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{jpeg}"/>
  </element>

  <set name="rawImages">
    <vdl:new type="Image" dbgname="rawImages" isArray="true">
      <vdl:mapping descriptor="dir_mapper">
        <vdl:parameter name="location">
          <string>rawdir</string>
        </vdl:parameter>
        <vdl:parameter name="suffix">
          <string>.fits</string>
        </vdl:parameter>
        <vdl:parameter name="input" value="true"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="template">
    <vdl:new type="Header" dbgname="template">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="template.hdr"/>
        <vdl:parameter name="input" value="true"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="projectedImages">
    <vdl:new type="Image" dbgname="projectedImages" isArray="true">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix" value="projectedImages-299d7743-53c2-4722-b946-473c331f5196"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="projectedAreas">
    <vdl:new type="Image" dbgname="projectedAreas" isArray="true">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix" value="projectedAreas-e0c8fae2-2cdd-45ea-9e44-e1743d0859df"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="projImgTbl">
    <vdl:new type="Table" dbgname="projImgTbl">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="projImg.tbl"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="diffsTbl">
    <vdl:new type="Table" dbgname="diffsTbl">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="diffs.tbl"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="diffImgs">
    <vdl:new type="Image" dbgname="diffImgs" isArray="true">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix" value="diffImgs-93f7b1e3-7408-4023-90f7-188f05ab191f"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="statusFiles">
    <vdl:new type="TxtFile" dbgname="statusFiles" isArray="true">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix" value="statusFiles-e8e4a828-191d-4496-ae4a-b0eb79247559"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="statusFilesTbl">
    <vdl:new type="Table" dbgname="statusFilesTbl">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="statfile.tbl"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="fitsTbl">
    <vdl:new type="Table" dbgname="fitsTbl">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="fits.tbl"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="correctionsTbl">
    <vdl:new type="Table" dbgname="correctionsTbl">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="corrections.tbl"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="correctedImages">
    <vdl:new type="Image" dbgname="correctedImages" isArray="true">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix" value="correctedImages-41ef2d9f-1bb9-4d9c-b24a-00bdc21b433b"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="correctedAreas">
    <vdl:new type="Image" dbgname="correctedAreas" isArray="true">
      <vdl:mapping descriptor="concurrent_mapper">
        <vdl:parameter name="prefix" value="correctedAreas-58222193-1096-460d-aa25-a30ec2ef2c28"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="corrImgTbl">
    <vdl:new type="Table" dbgname="corrImgTbl">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="corrImg.tbl"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="mosaic">
    <vdl:new type="Image" dbgname="mosaic">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="mosaic.fits"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="mosaicArea">
    <vdl:new type="Image" dbgname="mosaicArea">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="mosaic_area.fits"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="smallMosaic">
    <vdl:new type="Image" dbgname="smallMosaic">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="smallMosaic.fits"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="jpeg">
    <vdl:new type="JPEG" dbgname="jpeg">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="mosaic.jpg"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <restartLog>
  	<vdl:pre/>
  	<vdl:mains>
		<vdl:mainp>
		    <parallel>
    		  <mProjectPPBatch>
    		    <parallel>
    		      <variable>projectedImages</variable>
    		      <variable>projectedAreas</variable>
    		      <variable>rawImages</variable>
    		      <variable>template</variable>
    		    </parallel>
    		  </mProjectPPBatch>
    		  <mImgtbl>
    		    <parallel>
    		      <variable>projImgTbl</variable>
    		      <vdl:new value="&quot;.&quot;"/>
    		      <variable>projectedImages</variable>
    		    </parallel>
    		  </mImgtbl>
    		  <mOverlaps>
    		    <parallel>
    		      <variable>diffsTbl</variable>
    		      <variable>projImgTbl</variable>
    		    </parallel>
    		  </mOverlaps>
    		  <mDiffFitBatch>
    		    <parallel>
    		      <variable>diffImgs</variable>
    		      <variable>statusFiles</variable>
    		      <variable>diffsTbl</variable>
    		      <variable>template</variable>
    		    </parallel>
    		  </mDiffFitBatch>
    		  <mStatTbl>
    		    <parallel>
    		      <variable>statusFilesTbl</variable>
    		      <variable>diffsTbl</variable>
    		    </parallel>
    		  </mStatTbl>
    		  <mConcatFit>
    		    <parallel>
    		      <variable>fitsTbl</variable>
    		      <variable>statusFilesTbl</variable>
    		      <variable>statusFiles</variable>
    		      <vdl:new value="&quot;.&quot;"/>
    		    </parallel>
    		  </mConcatFit>
    		  <mBgModel>
    		    <parallel>
    		      <variable>correctionsTbl</variable>
    		      <variable>projImgTbl</variable>
    		      <variable>fitsTbl</variable>
    		    </parallel>
    		  </mBgModel>
    		  <mBackgroundBatch>
    		    <parallel>
    		      <variable>correctedImages</variable>
    		      <variable>correctedAreas</variable>
    		      <variable>projectedImages</variable>
    		      <variable>projectedAreas</variable>
    		      <variable>projImgTbl</variable>
    		      <variable>correctionsTbl</variable>
    		    </parallel>
    		  </mBackgroundBatch>
    		  <mImgtbl>
    		    <parallel>
    		      <variable>corrImgTbl</variable>
    		      <vdl:new value="&quot;.&quot;"/>
    		      <variable>correctedImages</variable>
    		    </parallel>
    		  </mImgtbl>
    		  <mAdd>
    		    <parallel>
    		      <variable>mosaic</variable>
    		      <variable>mosaicArea</variable>
    		      <variable>corrImgTbl</variable>
    		      <variable>template</variable>
    		      <variable>correctedImages</variable>
    		      <variable>correctedAreas</variable>
    		    </parallel>
    		  </mAdd>
    		  <mShrink>
    		    <parallel>
    		      <variable>smallMosaic</variable>
    		      <variable>mosaic</variable>
    		      <vdl:new value="3"/>
    		    </parallel>
    		  </mShrink>
    		  <mJPEG>
    		    <parallel>
    		      <variable>jpeg</variable>
    		      <variable>smallMosaic</variable>
    		    </parallel>
    		  </mJPEG>
	    	</parallel>
		</vdl:mainp>
	</vdl:mains>
	<vdl:post/>
  </restartLog>  
</project>
