<program xmlns="http://ci.uchicago.edu/swift/2007/07/swiftscript"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns:xs="http://www.w3.org/2001/XMLSchema">
  <types>
    <xs:schema targetNamespace="http://ci.uchicago.edu/swift/2007/07/swiftscript">
     <xs:simpleType name="Image">
       <xs:restriction base="string"/>
     </xs:simpleType>
     <xs:simpleType name="Header">
       <xs:restriction base="string"/>
     </xs:simpleType>
     <xs:simpleType name="Table">
       <xs:restriction base="string"/>
     </xs:simpleType>
     <xs:complexType name="DiffStruct">
       <xs:sequence>
           <xs:element name="cntr1" type="int"/>
           <xs:element name="cntr2" type="int"/>
           <xs:element name="plus" type="Image"/>
           <xs:element name="minus" type="Image"/>
           <xs:element name="diff" type="Image"/>
       </xs:sequence>
     </xs:complexType>
     <xs:simpleType name="TxtFile">
       <xs:restriction base="string"/>
     </xs:simpleType>
     <xs:simpleType name="JPEG">
       <xs:restriction base="string"/>
     </xs:simpleType>
    </xs:schema>
  </types>
  <procedure name="mProjectPP">

      <output 
    name="projectedImage" type="Image"

     xsi:nil="true" />

      <output 
    name="projectedArea" type="Image"

     xsi:nil="true" />

      <input 
    name="rawImage" type="Image"

     xsi:nil="true" />

      <input 
    name="template" type="Header"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mProjectPP</executable>
        <stringConstant>-X</stringConstant><function name="filename">
          <variableReference>rawImage</variableReference></function><function name="filename">
          <variableReference>projectedImage</variableReference></function><function name="filename">
          <variableReference>template</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mProjectPPBatch">

      <output 
    name="projectedImages" type="Image[]"

     xsi:nil="true" />

      <output 
    name="projectedAreas" type="Image[]"

     xsi:nil="true" />

      <input 
    name="rawImages" type="Image[]"

     xsi:nil="true" />

      <input 
    name="template" type="Header"

     xsi:nil="true" />
    <foreach var="img"  indexVar="i">
    <in><variableReference>rawImages</variableReference></in>
    <body><dataset name="projImg" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">
            <variableReference>img</variableReference></function></param>
          <param name="match"><stringConstant>.*\/(.*)</stringConstant></param>
          <param name="transform"><stringConstant>proj_\1</stringConstant></param>
        </mapping>
      </dataset>
      <dataset name="areaImg" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">
            <variableReference>projImg</variableReference></function></param>
          <param name="match"><stringConstant>(.*)\.(.*)</stringConstant></param>
          <param name="transform"><stringConstant>\1_area.\2</stringConstant></param>
        </mapping>
      </dataset>
      <call proc="mProjectPP">
        <output><variableReference>projImg</variableReference></output>
        <output><variableReference>areaImg</variableReference></output>
        <input><variableReference>img</variableReference></input>
        <input><variableReference>template</variableReference></input>
      </call>
      <assign>
       <arraySubscript>
        <variableReference>projectedImages</variableReference>
        <variableReference>i</variableReference>
       </arraySubscript>
       <variableReference>projImg</variableReference>
      </assign>
      <assign>
       <arraySubscript>
        <variableReference>projectedAreas</variableReference>
        <variableReference>i</variableReference>
       </arraySubscript>
       <variableReference>areaImg</variableReference>
      </assign></body>
    </foreach>
  </procedure>
  <procedure name="mOverlaps">

      <output 
    name="diffsTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="imagesTbl" type="Table"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mOverlaps</executable>
        <function name="filename">
          <variableReference>imagesTbl</variableReference></function><function name="filename">
          <variableReference>diffsTbl</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mDiffFit">

      <output 
    name="diffImage" type="Image"

     xsi:nil="true" />

      <output 
    name="statusFile" type="TxtFile"

     xsi:nil="true" />

      <input 
    name="projectedImage1" type="Image"

     xsi:nil="true" />

      <input 
    name="projectedArea1" type="Image"

     xsi:nil="true" />

      <input 
    name="projectedImage2" type="Image"

     xsi:nil="true" />

      <input 
    name="projectedArea2" type="Image"

     xsi:nil="true" />

      <input 
    name="template" type="Header"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mDiffFit</executable>
        <stringConstant>-s</stringConstant><function name="filename">
          <variableReference>statusFile</variableReference></function><function name="filename">
          <variableReference>projectedImage1</variableReference></function><function name="filename">
          <variableReference>projectedImage2</variableReference></function><function name="filename">
          <variableReference>diffImage</variableReference></function><function name="filename">
          <variableReference>template</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mDiffFitBatch">

      <output 
    name="diffImages" type="Image[]"

     xsi:nil="true" />

      <output 
    name="statusFiles" type="TxtFile[]"

     xsi:nil="true" />

      <input 
    name="diffsTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="template" type="Header"

     xsi:nil="true" />
    <dataset name="diffs" type="DiffStruct[]">
      <mapping descriptor="csv_mapper">
        <param name="file"><function name="filename">
          <variableReference>diffsTbl</variableReference></function></param>
        <param name="skip"><integerConstant>1</integerConstant></param>
        <param name="hdelim"><stringConstant> |</stringConstant></param>
      </mapping>
    </dataset>
    <foreach var="d"  indexVar="i">
    <in><variableReference>diffs</variableReference></in>
    <body><variable name="image1" type="Image"><structureMember>
        <variableReference>d</variableReference>
        <memberName>plus</memberName>
      </structureMember></variable>
      <dataset name="area1" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">
            <variableReference>image1</variableReference></function></param>
          <param name="match"><stringConstant>(.*)\.(.*)</stringConstant></param>
          <param name="transform"><stringConstant>\1_area.\2</stringConstant></param>
        </mapping>
      </dataset>
      <variable name="image2" type="Image"><structureMember>
        <variableReference>d</variableReference>
        <memberName>minus</memberName>
      </structureMember></variable>
      <dataset name="area2" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">
            <variableReference>image2</variableReference></function></param>
          <param name="match"><stringConstant>(.*)\.(.*)</stringConstant></param>
          <param name="transform"><stringConstant>\1_area.\2</stringConstant></param>
        </mapping>
      </dataset>
      <dataset name="diffImg" type="Image">
        <mapping descriptor="fixed_mapper">
          <param name="file"><function name="filename">
            <structureMember>
              <variableReference>d</variableReference>
              <memberName>diff</memberName>
            </structureMember></function></param>
        </mapping>
      </dataset>
      <dataset name="statusFile" type="TxtFile">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">
            <variableReference>diffImg</variableReference></function></param>
          <param name="match"><stringConstant>diff(.*)fits</stringConstant></param>
          <param name="transform"><stringConstant>fit\1txt</stringConstant></param>
        </mapping>
      </dataset>
      <call proc="mDiffFit">
        <output><variableReference>diffImg</variableReference></output>
        <output><variableReference>statusFile</variableReference></output>
        <input><variableReference>image1</variableReference></input>
        <input><variableReference>area1</variableReference></input>
        <input><variableReference>image2</variableReference></input>
        <input><variableReference>area2</variableReference></input>
        <input><variableReference>template</variableReference></input>
      </call>
      <assign>
       <arraySubscript>
        <variableReference>diffImages</variableReference>
        <variableReference>i</variableReference>
       </arraySubscript>
       <variableReference>diffImg</variableReference>
      </assign>
      <assign>
       <arraySubscript>
        <variableReference>statusFiles</variableReference>
        <variableReference>i</variableReference>
       </arraySubscript>
       <variableReference>statusFile</variableReference>
      </assign></body>
    </foreach>
  </procedure>
  <procedure name="mStatTbl">

      <output 
    name="statusFilesTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="diffsTbl" type="Table"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mStatTbl</executable>
        <function name="filename">
          <variableReference>diffsTbl</variableReference></function><function name="filename">
          <variableReference>statusFilesTbl</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mConcatFit">

      <output 
    name="fitsTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="statusFilesTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="statusFiles" type="TxtFile[]"

     xsi:nil="true" />

      <input 
    name="statusDir" type="string"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mConcatFit</executable>
        <function name="filename">
          <variableReference>statusFilesTbl</variableReference></function><function name="filename">
          <variableReference>fitsTbl</variableReference></function><variableReference>statusDir</variableReference>  </application>
    </binding>
  </procedure>
  <procedure name="mBgModel">

      <output 
    name="correctionsTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="projectedImagesTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="fitsTbl" type="Table"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mBgModel</executable>
        <function name="filename">
          <variableReference>projectedImagesTbl</variableReference></function><function name="filename">
          <variableReference>fitsTbl</variableReference></function><function name="filename">
          <variableReference>correctionsTbl</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mBackground">

      <output 
    name="correctedImage" type="Image"

     xsi:nil="true" />

      <output 
    name="correctedArea" type="Image"

     xsi:nil="true" />

      <input 
    name="projectedImage" type="Image"

     xsi:nil="true" />

      <input 
    name="projectedArea" type="Image"

     xsi:nil="true" />

      <input 
    name="projectedImagesTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="correctionsTbl" type="Table"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mBackground</executable>
        <stringConstant>-t</stringConstant><function name="filename">
          <variableReference>projectedImage</variableReference></function><function name="filename">
          <variableReference>correctedImage</variableReference></function><function name="filename">
          <variableReference>projectedImagesTbl</variableReference></function><function name="filename">
          <variableReference>correctionsTbl</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mBackgroundBatch">

      <output 
    name="correctedImages" type="Image[]"

     xsi:nil="true" />

      <output 
    name="correctedAreas" type="Image[]"

     xsi:nil="true" />

      <input 
    name="projectedImages" type="Image[]"

     xsi:nil="true" />

      <input 
    name="projectedAreas" type="Image[]"

     xsi:nil="true" />

      <input 
    name="projectedImagesTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="correctionsTbl" type="Table"

     xsi:nil="true" />
    <foreach var="projImg"  indexVar="i">
    <in><variableReference>projectedImages</variableReference></in>
    <body><variable name="projArea" type="Image"><arraySubscript>
       <variableReference>projectedAreas</variableReference>
       <variableReference>i</variableReference>
      </arraySubscript></variable>
      <dataset name="corrImg" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">
            <variableReference>projImg</variableReference></function></param>
          <param name="match"><stringConstant>proj_(.*)</stringConstant></param>
          <param name="transform"><stringConstant>corr_\1</stringConstant></param>
        </mapping>
      </dataset>
      <dataset name="corrArea" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">
            <variableReference>corrImg</variableReference></function></param>
          <param name="match"><stringConstant>(.*)\.(.*)</stringConstant></param>
          <param name="transform"><stringConstant>\1_area.\2</stringConstant></param>
        </mapping>
      </dataset>
      <call proc="mBackground">
        <output><variableReference>corrImg</variableReference></output>
        <output><variableReference>corrArea</variableReference></output>
        <input><variableReference>projImg</variableReference></input>
        <input><variableReference>projArea</variableReference></input>
        <input><variableReference>projectedImagesTbl</variableReference></input>
        <input><variableReference>correctionsTbl</variableReference></input>
      </call>
      <assign>
       <arraySubscript>
        <variableReference>correctedImages</variableReference>
        <variableReference>i</variableReference>
       </arraySubscript>
       <variableReference>corrImg</variableReference>
      </assign>
      <assign>
       <arraySubscript>
        <variableReference>correctedAreas</variableReference>
        <variableReference>i</variableReference>
       </arraySubscript>
       <variableReference>corrArea</variableReference>
      </assign></body>
    </foreach>
  </procedure>
  <procedure name="mImgtbl">

      <output 
    name="imagesTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="imageDir" type="string"

     xsi:nil="true" />

      <input 
    name="images" type="Image[]"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mImgtbl</executable>
        <variableReference>imageDir</variableReference><function name="filename">
          <variableReference>imagesTbl</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mImgtbl_t">

      <output 
    name="newImagesTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="imageDir" type="string"

     xsi:nil="true" />

      <input 
    name="images" type="Image[]"

     xsi:nil="true" />

      <input 
    name="oldImagesTbl" type="Table"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mImgtbl</executable>
        <variableReference>imageDir</variableReference><stringConstant>-t</stringConstant><function name="filename">
          <variableReference>oldImagesTbl</variableReference></function><function name="filename">
          <variableReference>newImagesTbl</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mAdd">

      <output 
    name="mosaic" type="Image"

     xsi:nil="true" />

      <output 
    name="mosaicArea" type="Image"

     xsi:nil="true" />

      <input 
    name="imagesTbl" type="Table"

     xsi:nil="true" />

      <input 
    name="template" type="Header"

     xsi:nil="true" />

      <input 
    name="images" type="Image[]"

     xsi:nil="true" />

      <input 
    name="imageAreas" type="Image[]"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mAdd</executable>
        <stringConstant>-e</stringConstant><function name="filename">
          <variableReference>imagesTbl</variableReference></function><function name="filename">
          <variableReference>template</variableReference></function><function name="filename">
          <variableReference>mosaic</variableReference></function>  </application>
    </binding>
  </procedure>
  <procedure name="mShrink">

      <output 
    name="shrunkImage" type="Image"

     xsi:nil="true" />

      <input 
    name="image" type="Image"

     xsi:nil="true" />

      <input 
    name="factor" type="float"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mShrink</executable>
        <function name="filename">
          <variableReference>image</variableReference></function><function name="filename">
          <variableReference>shrunkImage</variableReference></function><variableReference>factor</variableReference>  </application>
    </binding>
  </procedure>
  <procedure name="mJPEG">

      <output 
    name="jpeg" type="JPEG"

     xsi:nil="true" />

      <input 
    name="image" type="Image"

     xsi:nil="true" />
    <binding>
      <application>
        <executable>mJPEG</executable>
        <stringConstant>-ct</stringConstant><integerConstant>1</integerConstant><stringConstant>-gray</stringConstant><function name="filename">
          <variableReference>image</variableReference></function><stringConstant>-1.5s</stringConstant><stringConstant>60s</stringConstant><stringConstant>gaussian</stringConstant><stringConstant>-out</stringConstant><function name="filename">
          <variableReference>jpeg</variableReference></function>  </application>
    </binding>
  </procedure>
  <dataset name="rawImages" type="Image[]">
    <mapping descriptor="dir_mapper">
      <param name="location"><stringConstant>rawdir</stringConstant></param>
      <param name="suffix"><stringConstant>.fits</stringConstant></param>
    </mapping>
  </dataset>
  <dataset name="template" type="Header">
    <file name="template.hdr"/>
  </dataset>
  <variable name="projectedImages" type="Image[]" xsi:nil="true"/>
  <variable name="projectedAreas" type="Image[]" xsi:nil="true"/>
  <call proc="mProjectPPBatch">
    <output><variableReference>projectedImages</variableReference></output>
    <output><variableReference>projectedAreas</variableReference></output>
    <input><variableReference>rawImages</variableReference></input>
    <input><variableReference>template</variableReference></input>
  </call>
  <dataset name="projImgTbl" type="Table">
    <file name="projImg.tbl"/>
  </dataset>
  <call proc="mImgtbl">
    <output><variableReference>projImgTbl</variableReference></output>
    <input><stringConstant>.</stringConstant></input>
    <input><variableReference>projectedImages</variableReference></input>
  </call>
  <dataset name="diffsTbl" type="Table">
    <file name="diffs.tbl"/>
  </dataset>
  <call proc="mOverlaps">
    <output><variableReference>diffsTbl</variableReference></output>
    <input><variableReference>projImgTbl</variableReference></input>
  </call>
  <variable name="diffImgs" type="Image[]" xsi:nil="true"/>
  <variable name="statusFiles" type="TxtFile[]" xsi:nil="true"/>
  <call proc="mDiffFitBatch">
    <output><variableReference>diffImgs</variableReference></output>
    <output><variableReference>statusFiles</variableReference></output>
    <input><variableReference>diffsTbl</variableReference></input>
    <input><variableReference>template</variableReference></input>
  </call>
  <dataset name="statusFilesTbl" type="Table">
    <file name="statfile.tbl"/>
  </dataset>
  <call proc="mStatTbl">
    <output><variableReference>statusFilesTbl</variableReference></output>
    <input><variableReference>diffsTbl</variableReference></input>
  </call>
  <dataset name="fitsTbl" type="Table">
    <file name="fits.tbl"/>
  </dataset>
  <call proc="mConcatFit">
    <output><variableReference>fitsTbl</variableReference></output>
    <input><variableReference>statusFilesTbl</variableReference></input>
    <input><variableReference>statusFiles</variableReference></input>
    <input><stringConstant>.</stringConstant></input>
  </call>
  <dataset name="correctionsTbl" type="Table">
    <file name="corrections.tbl"/>
  </dataset>
  <call proc="mBgModel">
    <output><variableReference>correctionsTbl</variableReference></output>
    <input><variableReference>projImgTbl</variableReference></input>
    <input><variableReference>fitsTbl</variableReference></input>
  </call>
  <variable name="correctedImages" type="Image[]" xsi:nil="true"/>
  <variable name="correctedAreas" type="Image[]" xsi:nil="true"/>
  <call proc="mBackgroundBatch">
    <output><variableReference>correctedImages</variableReference></output>
    <output><variableReference>correctedAreas</variableReference></output>
    <input><variableReference>projectedImages</variableReference></input>
    <input><variableReference>projectedAreas</variableReference></input>
    <input><variableReference>projImgTbl</variableReference></input>
    <input><variableReference>correctionsTbl</variableReference></input>
  </call>
  <dataset name="corrImgTbl" type="Table">
    <file name="corrImg.tbl"/>
  </dataset>
  <call proc="mImgtbl">
    <output><variableReference>corrImgTbl</variableReference></output>
    <input><stringConstant>.</stringConstant></input>
    <input><variableReference>correctedImages</variableReference></input>
  </call>
  <dataset name="mosaic" type="Image">
    <file name="mosaic.fits"/>
  </dataset>
  <dataset name="mosaicArea" type="Image">
    <file name="mosaic_area.fits"/>
  </dataset>
  <call proc="mAdd">
    <output><variableReference>mosaic</variableReference></output>
    <output><variableReference>mosaicArea</variableReference></output>
    <input><variableReference>corrImgTbl</variableReference></input>
    <input><variableReference>template</variableReference></input>
    <input><variableReference>correctedImages</variableReference></input>
    <input><variableReference>correctedAreas</variableReference></input>
  </call>
  <dataset name="smallMosaic" type="Image">
    <file name="smallMosaic.fits"/>
  </dataset>
  <call proc="mShrink">
    <output><variableReference>smallMosaic</variableReference></output>
    <input><variableReference>mosaic</variableReference></input>
    <input><integerConstant>3</integerConstant></input>
  </call>
  <dataset name="jpeg" type="JPEG">
    <file name="mosaic.jpg"/>
  </dataset>
  <call proc="mJPEG">
    <output><variableReference>jpeg</variableReference></output>
    <input><variableReference>smallMosaic</variableReference></input>
  </call>
</program>
