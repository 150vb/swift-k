<program xmlns="http://www.griphyn.org/2006/08/vdl"
         xmlns:xs="http://www.w3.org/2001/XMLSchema">
  <types>
    <xs:schema xmlns="http://www.griphyn.org/2006/08/vdl" targetNamespace="http://www.griphyn.org/2006/08/vdl">
     <xs:simpleType name="Image">
       <xs:restriction base="xs:string"/>
     </xs:simpleType>
     <xs:simpleType name="Header">
       <xs:restriction base="xs:string"/>
     </xs:simpleType>
     <xs:simpleType name="Table">
       <xs:restriction base="xs:string"/>
     </xs:simpleType>
     <xs:complexType name="DiffStruct">
       <xs:sequence>
           <xs:element name="cntr1" type="xs:int"/>
           <xs:element name="cntr2" type="xs:int"/>
           <xs:element name="plus" type="Image"/>
           <xs:element name="minus" type="Image"/>
           <xs:element name="diff" type="Image"/>
       </xs:sequence>
     </xs:complexType>
     <xs:simpleType name="TxtFile">
       <xs:restriction base="xs:string"/>
     </xs:simpleType>
     <xs:simpleType name="JPEG">
       <xs:restriction base="xs:string"/>
     </xs:simpleType>
    </xs:schema>
  </types>
  <procedure name="mProjectPP">
    <output name="projectedImage" type="Image"/>
    <output name="projectedArea" type="Image"/>
    <input name="rawImage" type="Image"/>
    <input name="template" type="Header"/>
    <binding type="app">
      <application>
        <executable>mProjectPP</executable>
        <argument>&quot;-X&quot;</argument>
        <argument><function name="filename">rawImage</function></argument>
        <argument><function name="filename">projectedImage</function></argument>
        <argument><function name="filename">template</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mProjectPPBatch">
    <output name="projectedImages" type="Image" isArray="true"/>
    <output name="projectedAreas" type="Image" isArray="true"/>
    <input name="rawImages" type="Image" isArray="true"/>
    <input name="template" type="Header"/>
    <variable name="img" type="Image"/>
    <foreach var="img" in="rawImages" indexVar="i">
      <dataset name="projImg" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">img</function></param>
          <param name="match">&quot;.*\/(.*)&quot;</param>
          <param name="transform">&quot;proj_\1&quot;</param>
        </mapping>
      </dataset>
      <dataset name="areaImg" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">projImg</function></param>
          <param name="match">&quot;(.*)\.(.*)&quot;</param>
          <param name="transform">&quot;\1_area.\2&quot;</param>
        </mapping>
      </dataset>
      <call proc="mProjectPP">
        <output>projImg</output>
        <output>areaImg</output>
        <input>img</input>
        <input>template</input>
      </call>
      <assign to="projectedImages[i]">projImg</assign>
      <assign to="projectedAreas[i]">areaImg</assign>
    </foreach>
  </procedure>
  <procedure name="mOverlaps">
    <output name="diffsTbl" type="Table"/>
    <input name="imagesTbl" type="Table"/>
    <binding type="app">
      <application>
        <executable>mOverlaps</executable>
        <argument><function name="filename">imagesTbl</function></argument>
        <argument><function name="filename">diffsTbl</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mDiffFit">
    <output name="diffImage" type="Image"/>
    <output name="statusFile" type="TxtFile"/>
    <input name="projectedImage1" type="Image"/>
    <input name="projectedArea1" type="Image"/>
    <input name="projectedImage2" type="Image"/>
    <input name="projectedArea2" type="Image"/>
    <input name="template" type="Header"/>
    <binding type="app">
      <application>
        <executable>mDiffFit</executable>
        <argument>&quot;-s&quot;</argument>
        <argument><function name="filename">statusFile</function></argument>
        <argument><function name="filename">projectedImage1</function></argument>
        <argument><function name="filename">projectedImage2</function></argument>
        <argument><function name="filename">diffImage</function></argument>
        <argument><function name="filename">template</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mDiffFitBatch">
    <output name="diffImages" type="Image" isArray="true"/>
    <output name="statusFiles" type="TxtFile" isArray="true"/>
    <input name="diffsTbl" type="Table"/>
    <input name="template" type="Header"/>
    <dataset name="diffs" type="DiffStruct" isArray="true">
      <mapping descriptor="csv_mapper">
        <param name="file"><function name="filename">diffsTbl</function></param>
        <param name="skip">1</param>
        <param name="hdelim">&quot; |&quot;</param>
      </mapping>
    </dataset>
    <foreach var="d" in="diffs" indexVar="i">
      <variable name="image1" type="Image">d.plus</variable>
      <dataset name="area1" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">image1</function></param>
          <param name="match">&quot;(.*)\.(.*)&quot;</param>
          <param name="transform">&quot;\1_area.\2&quot;</param>
        </mapping>
      </dataset>
      <variable name="image2" type="Image">d.minus</variable>
      <dataset name="area2" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">image2</function></param>
          <param name="match">&quot;(.*)\.(.*)&quot;</param>
          <param name="transform">&quot;\1_area.\2&quot;</param>
        </mapping>
      </dataset>
      <dataset name="diffImg" type="Image">
        <mapping descriptor="fixed_mapper">
          <param name="file"><function name="filename">d.diff</function></param>
        </mapping>
      </dataset>
      <dataset name="statusFile" type="TxtFile">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">diffImg</function></param>
          <param name="match">&quot;diff(.*)fits&quot;</param>
          <param name="transform">&quot;fit\1txt&quot;</param>
        </mapping>
      </dataset>
      <call proc="mDiffFit">
        <output>diffImg</output>
        <output>statusFile</output>
        <input>image1</input>
        <input>area1</input>
        <input>image2</input>
        <input>area2</input>
        <input>template</input>
      </call>
      <assign to="diffImages[i]">diffImg</assign>
      <assign to="statusFiles[i]">statusFile</assign>
    </foreach>
  </procedure>
  <procedure name="mStatTbl">
    <output name="statusFilesTbl" type="Table"/>
    <input name="diffsTbl" type="Table"/>
    <binding type="app">
      <application>
        <executable>mStatTbl</executable>
        <argument><function name="filename">diffsTbl</function></argument>
        <argument><function name="filename">statusFilesTbl</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mConcatFit">
    <output name="fitsTbl" type="Table"/>
    <input name="statusFilesTbl" type="Table"/>
    <input name="statusFiles" type="TxtFile" isArray="true"/>
    <input name="statusDir" type="string"/>
    <binding type="app">
      <application>
        <executable>mConcatFit</executable>
        <argument><function name="filename">statusFilesTbl</function></argument>
        <argument><function name="filename">fitsTbl</function></argument>
        <argument>statusDir</argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mBgModel">
    <output name="correctionsTbl" type="Table"/>
    <input name="projectedImagesTbl" type="Table"/>
    <input name="fitsTbl" type="Table"/>
    <binding type="app">
      <application>
        <executable>mBgModel</executable>
        <argument><function name="filename">projectedImagesTbl</function></argument>
        <argument><function name="filename">fitsTbl</function></argument>
        <argument><function name="filename">correctionsTbl</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mBackground">
    <output name="correctedImage" type="Image"/>
    <output name="correctedArea" type="Image"/>
    <input name="projectedImage" type="Image"/>
    <input name="projectedArea" type="Image"/>
    <input name="projectedImagesTbl" type="Table"/>
    <input name="correctionsTbl" type="Table"/>
    <binding type="app">
      <application>
        <executable>mBackground</executable>
        <argument>&quot;-t&quot;</argument>
        <argument><function name="filename">projectedImage</function></argument>
        <argument><function name="filename">correctedImage</function></argument>
        <argument><function name="filename">projectedImagesTbl</function></argument>
        <argument><function name="filename">correctionsTbl</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mBackgroundBatch">
    <output name="correctedImages" type="Image" isArray="true"/>
    <output name="correctedAreas" type="Image" isArray="true"/>
    <input name="projectedImages" type="Image" isArray="true"/>
    <input name="projectedAreas" type="Image" isArray="true"/>
    <input name="projectedImagesTbl" type="Table"/>
    <input name="correctionsTbl" type="Table"/>
    <foreach var="projImg" in="projectedImages" indexVar="i">
      <variable name="projArea" type="Image">projectedAreas[i]</variable>
      <dataset name="corrImg" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">projImg</function></param>
          <param name="match">&quot;proj_(.*)&quot;</param>
          <param name="transform">&quot;corr_\1&quot;</param>
        </mapping>
      </dataset>
      <dataset name="corrArea" type="Image">
        <mapping descriptor="regexp_mapper">
          <param name="source"><function name="filename">corrImg</function></param>
          <param name="match">&quot;(.*)\.(.*)&quot;</param>
          <param name="transform">&quot;\1_area.\2&quot;</param>
        </mapping>
      </dataset>
      <call proc="mBackground">
        <output>corrImg</output>
        <output>corrArea</output>
        <input>projImg</input>
        <input>projArea</input>
        <input>projectedImagesTbl</input>
        <input>correctionsTbl</input>
      </call>
      <assign to="correctedImages[i]">corrImg</assign>
      <assign to="correctedAreas[i]">corrArea</assign>
    </foreach>
  </procedure>
  <procedure name="mImgtbl">
    <output name="imagesTbl" type="Table"/>
    <input name="imageDir" type="string"/>
    <input name="images" type="Image" isArray="true"/>
    <binding type="app">
      <application>
        <executable>mImgtbl</executable>
        <argument>imageDir</argument>
        <argument><function name="filename">imagesTbl</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mImgtbl_t">
    <output name="newImagesTbl" type="Table"/>
    <input name="imageDir" type="string"/>
    <input name="images" type="Image" isArray="true"/>
    <input name="oldImagesTbl" type="Table"/>
    <binding type="app">
      <application>
        <executable>mImgtbl</executable>
        <argument>imageDir</argument>
        <argument>&quot;-t&quot;</argument>
        <argument><function name="filename">oldImagesTbl</function></argument>
        <argument><function name="filename">newImagesTbl</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mAdd">
    <output name="mosaic" type="Image"/>
    <output name="mosaicArea" type="Image"/>
    <input name="imagesTbl" type="Table"/>
    <input name="template" type="Header"/>
    <input name="images" type="Image" isArray="true"/>
    <input name="imageAreas" type="Image" isArray="true"/>
    <binding type="app">
      <application>
        <executable>mAdd</executable>
        <argument>&quot;-e&quot;</argument>
        <argument><function name="filename">imagesTbl</function></argument>
        <argument><function name="filename">template</function></argument>
        <argument><function name="filename">mosaic</function></argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mShrink">
    <output name="shrunkImage" type="Image"/>
    <input name="image" type="Image"/>
    <input name="factor" type="float"/>
    <binding type="app">
      <application>
        <executable>mShrink</executable>
        <argument><function name="filename">image</function></argument>
        <argument><function name="filename">shrunkImage</function></argument>
        <argument>factor</argument>
      </application>
    </binding>
  </procedure>
  <procedure name="mJPEG">
    <output name="jpeg" type="JPEG"/>
    <input name="image" type="Image"/>
    <binding type="app">
      <application>
        <executable>mJPEG</executable>
        <argument>&quot;-ct&quot;</argument>
        <argument>1</argument>
        <argument>&quot;-gray&quot;</argument>
        <argument><function name="filename">image</function></argument>
        <argument>&quot;-1.5s&quot;</argument>
        <argument>&quot;60s&quot;</argument>
        <argument>&quot;gaussian&quot;</argument>
        <argument>&quot;-out&quot;</argument>
        <argument><function name="filename">jpeg</function></argument>
      </application>
    </binding>
  </procedure>
  <dataset name="rawImages" type="Image" isArray="true">
    <mapping descriptor="dir_mapper">
      <param name="location">&quot;rawdir&quot;</param>
      <param name="suffix">&quot;.fits&quot;</param>
    </mapping>
  </dataset>
  <dataset name="template" type="Header">
    <file name="template.hdr"/>
  </dataset>
  <variable name="projectedImages" type="Image" isArray="true"/>
  <variable name="projectedAreas" type="Image" isArray="true"/>
  <call proc="mProjectPPBatch">
    <output>projectedImages</output>
    <output>projectedAreas</output>
    <input>rawImages</input>
    <input>template</input>
  </call>
  <dataset name="projImgTbl" type="Table">
    <file name="projImg.tbl"/>
  </dataset>
  <call proc="mImgtbl">
    <output>projImgTbl</output>
    <input>&quot;.&quot;</input>
    <input>projectedImages</input>
  </call>
  <dataset name="diffsTbl" type="Table">
    <file name="diffs.tbl"/>
  </dataset>
  <call proc="mOverlaps">
    <output>diffsTbl</output>
    <input>projImgTbl</input>
  </call>
  <variable name="diffImgs" type="Image" isArray="true"/>
  <variable name="statusFiles" type="TxtFile" isArray="true"/>
  <call proc="mDiffFitBatch">
    <output>diffImgs</output>
    <output>statusFiles</output>
    <input>diffsTbl</input>
    <input>template</input>
  </call>
  <dataset name="statusFilesTbl" type="Table">
    <file name="statfile.tbl"/>
  </dataset>
  <call proc="mStatTbl">
    <output>statusFilesTbl</output>
    <input>diffsTbl</input>
  </call>
  <dataset name="fitsTbl" type="Table">
    <file name="fits.tbl"/>
  </dataset>
  <call proc="mConcatFit">
    <output>fitsTbl</output>
    <input>statusFilesTbl</input>
    <input>statusFiles</input>
    <input>&quot;.&quot;</input>
  </call>
  <dataset name="correctionsTbl" type="Table">
    <file name="corrections.tbl"/>
  </dataset>
  <call proc="mBgModel">
    <output>correctionsTbl</output>
    <input>projImgTbl</input>
    <input>fitsTbl</input>
  </call>
  <variable name="correctedImages" type="Image" isArray="true"/>
  <variable name="correctedAreas" type="Image" isArray="true"/>
  <call proc="mBackgroundBatch">
    <output>correctedImages</output>
    <output>correctedAreas</output>
    <input>projectedImages</input>
    <input>projectedAreas</input>
    <input>projImgTbl</input>
    <input>correctionsTbl</input>
  </call>
  <dataset name="corrImgTbl" type="Table">
    <file name="corrImg.tbl"/>
  </dataset>
  <call proc="mImgtbl">
    <output>corrImgTbl</output>
    <input>&quot;.&quot;</input>
    <input>correctedImages</input>
  </call>
  <dataset name="mosaic" type="Image">
    <file name="mosaic.fits"/>
  </dataset>
  <dataset name="mosaicArea" type="Image">
    <file name="mosaic_area.fits"/>
  </dataset>
  <call proc="mAdd">
    <output>mosaic</output>
    <output>mosaicArea</output>
    <input>corrImgTbl</input>
    <input>template</input>
    <input>correctedImages</input>
    <input>correctedAreas</input>
  </call>
  <dataset name="smallMosaic" type="Image">
    <file name="smallMosaic.fits"/>
  </dataset>
  <call proc="mShrink">
    <output>smallMosaic</output>
    <input>mosaic</input>
    <input>3</input>
  </call>
  <dataset name="jpeg" type="JPEG">
    <file name="mosaic.jpg"/>
  </dataset>
  <call proc="mJPEG">
    <output>jpeg</output>
    <input>smallMosaic</input>
  </call>
</program>
