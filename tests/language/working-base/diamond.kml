<project>
  <import file="sys.xml"/>
  <import file="scheduler.xml"/>
  <import file="rlog.xml"/>
  <import file="vdl.k"/>
  <types>
    <xs:schema targetNamespace="http://www.griphyn.org/2006/08/vdl" xmlns="http://www.griphyn.org/2006/08/vdl" xmlns:xs="http://www.w3.org/2001/XMLSchema">
      <xs:simpleType name="file">
        <xs:restriction base="xs:string"/>
      </xs:simpleType>
    </xs:schema>
  </types>
  <element name="generate" arguments="f,p1">
    <vdl:typecheck argname="f" var="{f}" type="file"/>
    <vdl:typecheck argname="p1" var="{p1}" type="float"/>
    <vdl:execute>
      <vdl:tr>generate</vdl:tr>
      <vdl:stagein var="{p1}"/>
      <vdl:stageout var="{f}"/>
      <vdl:arguments>
        <string>-aTOP -T4</string>	
        <string>-p</string>	
        <vdl:getfieldvalue var="{p1}"/>	
        <string>-o</string>	
        <vdl:filename var="{f}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{f}"/>
  </element>

  <element name="process" arguments="f2,f1,name,p2">
    <vdl:typecheck argname="f2" var="{f2}" type="file"/>
    <vdl:typecheck argname="f1" var="{f1}" type="file"/>
    <vdl:typecheck argname="name" var="{name}" type="string"/>
    <vdl:typecheck argname="p2" var="{p2}" type="float"/>
    <vdl:execute>
      <vdl:tr>process</vdl:tr>
      <vdl:stagein var="{f1}"/>
      <vdl:stagein var="{name}"/>
      <vdl:stagein var="{p2}"/>
      <vdl:stageout var="{f2}"/>
      <vdl:arguments>
        <string>-a</string>	
        <vdl:getfieldvalue var="{name}"/>	
        <string>-T4</string>	
        <string>-p</string>	
        <vdl:getfieldvalue var="{p2}"/>	
        <string>-i</string>	
        <vdl:filename var="{f1}"/>	
        <string>-o</string>	
        <vdl:filename var="{f2}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{f2}"/>
  </element>

  <element name="combine" arguments="f3,f1,f2">
    <vdl:typecheck argname="f3" var="{f3}" type="file"/>
    <vdl:typecheck argname="f1" var="{f1}" type="file"/>
    <vdl:typecheck argname="f2" var="{f2}" type="file"/>
    <vdl:execute>
      <vdl:tr>combine</vdl:tr>
      <vdl:stagein var="{f1}"/>
      <vdl:stagein var="{f2}"/>
      <vdl:stageout var="{f3}"/>
      <vdl:arguments>
        <string>-aBOTTOM -T4</string>	
        <string>-i</string>	
        <vdl:filename var="{f1}"/>	
        <vdl:filename var="{f2}"/>	
        <string>-o</string>	
        <vdl:filename var="{f3}"/>	
      </vdl:arguments>

    </vdl:execute>
    <vdl:closedataset var="{f3}"/>
  </element>

  <element name="diamond" arguments="fd,p1,p2">
    <vdl:typecheck argname="fd" var="{fd}" type="file"/>
    <vdl:typecheck argname="p1" var="{p1}" type="float"/>
    <vdl:typecheck argname="p2" var="{p2}" type="float"/>
    <set name="fa">
      <vdl:new type="file" dbgname="fa">
        <vdl:mapping descriptor="concurrent_mapper">
          <vdl:parameter name="prefix" value="fa-de0d906c-048d-44f7-b783-e4082e65736c"/>
        </vdl:mapping>
      </vdl:new>
    </set>
    <set name="fb">
      <vdl:new type="file" dbgname="fb">
        <vdl:mapping descriptor="concurrent_mapper">
          <vdl:parameter name="prefix" value="fb-5cefdea5-2e5c-40f3-93fe-8368765c6440"/>
        </vdl:mapping>
      </vdl:new>
    </set>
    <set name="fc">
      <vdl:new type="file" dbgname="fc">
        <vdl:mapping descriptor="concurrent_mapper">
          <vdl:parameter name="prefix" value="fc-11059b88-1fad-4be5-89a0-855ef7b4f8a3"/>
        </vdl:mapping>
      </vdl:new>
    </set>
    <parallel>
      <generate>
        <parallel>
          <variable>fa</variable>
          <variable>p1</variable>
        </parallel>
      </generate>
      <process>
        <parallel>
          <variable>fb</variable>
          <variable>fa</variable>
          <vdl:new value="&quot;LEFT&quot;"/>
          <variable>p2</variable>
        </parallel>
      </process>
      <process>
        <parallel>
          <variable>fc</variable>
          <variable>fa</variable>
          <vdl:new value="&quot;RIGHT&quot;"/>
          <variable>p2</variable>
        </parallel>
      </process>
      <combine>
        <parallel>
          <variable>fd</variable>
          <variable>fb</variable>
          <variable>fc</variable>
        </parallel>
      </combine>
    </parallel>
    <vdl:closedataset var="{fd}"/>
  </element>

  <set name="final">
    <vdl:new type="file" dbgname="final">
      <vdl:mapping descriptor="single_file_mapper">
        <vdl:parameter name="file" value="FINAL"/>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <restartLog>
  	<vdl:pre/>
  	<vdl:mains>
		<vdl:mainp>
		    <parallel>
    		  <diamond>
    		    <parallel>
    		      <variable>final</variable>
    		      <vdl:new value="1"/>
    		      <vdl:new value="100"/>
    		    </parallel>
    		  </diamond>
	    	</parallel>
		</vdl:mainp>
	</vdl:mains>
	<vdl:post/>
  </restartLog>  
</project>
