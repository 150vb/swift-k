<project>
  <import file="sys.xml"/>
  <import file="scheduler.xml"/>
  <import file="rlog.xml"/>
  <import file="vdl.k"/>
  <types>
    <xs:schema targetNamespace="http://www.griphyn.org/2006/08/vdl" xmlns="http://www.griphyn.org/2006/08/vdl" xmlns:xs="http://www.w3.org/2001/XMLSchema">
      <xs:simpleType name="messagefile">
        <xs:restriction base="xs:string"/>
      </xs:simpleType>
      <xs:simpleType name="countfile">
        <xs:restriction base="xs:string"/>
      </xs:simpleType>
    </xs:schema>
  </types>
  <element name="countwords" arguments="t,f">
    <vdl:typecheck argname="t" var="{t}" type="countfile"/>
    <vdl:typecheck argname="f" var="{f}" type="messagefile"/>
    <vdl:execute>
      <vdl:tr>wc</vdl:tr>
      <vdl:stagein var="{f}"/>
      <vdl:stageout var="{t}"/>
      <vdl:arguments>
        <string>-w</string>	
        <vdl:filename var="{f}"/>	
      </vdl:arguments>
      <vdl:stdout>
        <vdl:filename var="{t}"/>	
      </vdl:stdout>
    </vdl:execute>
    <vdl:closedataset var="{t}"/>
  </element>

  <set name="inputNames">
    <vdl:new type="string" dbgname="inputNames">
      <argument name="value">one.txt two.txt three.txt</argument>
    </vdl:new>
  </set>
  <set name="outputNames">
    <vdl:new type="string" dbgname="outputNames">
      <argument name="value">one.count two.count three.count</argument>
    </vdl:new>
  </set>
  <set name="inputfiles">
    <vdl:new type="messagefile" dbgname="inputfiles" isArray="true">
      <vdl:mapping descriptor="array_mapper">
        <vdl:parameter name="files">
          <variable>inputNames</variable>
        </vdl:parameter>
        <vdl:parameter name="input" value="true"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <set name="outputfiles">
    <vdl:new type="countfile" dbgname="outputfiles" isArray="true">
      <vdl:mapping descriptor="array_mapper">
        <vdl:parameter name="files">
          <variable>outputNames</variable>
        </vdl:parameter>
        <vdl:parameter name="input" value="false"/>
      </vdl:mapping>
    </vdl:new>
  </set>
  <restartLog>
  	<vdl:pre/>
  	<vdl:mains>
		<vdl:mainp>
		    <parallel>
    		  <countwords>
    		    <parallel>
    		      <vdl:getfield var="{outputfiles}" path="[0]"/>
    		      <vdl:getfield var="{inputfiles}" path="[0]"/>
    		    </parallel>
    		  </countwords>
    		  <countwords>
    		    <parallel>
    		      <vdl:getfield var="{outputfiles}" path="[1]"/>
    		      <vdl:getfield var="{inputfiles}" path="[1]"/>
    		    </parallel>
    		  </countwords>
    		  <countwords>
    		    <parallel>
    		      <vdl:getfield var="{outputfiles}" path="[2]"/>
    		      <vdl:getfield var="{inputfiles}" path="[2]"/>
    		    </parallel>
    		  </countwords>
	    	</parallel>
		</vdl:mainp>
	</vdl:mains>
	<vdl:post/>
  </restartLog>  
</project>
