<project><!-- CACHE ID abf630aa-7a86-4f7c-8484-2439be2e7702-no-provenance -->
  <import file="sys.xml"/>
  <import file="scheduler.xml"/>
  <import file="rlog.xml"/>
  <import file="vdl.k"/>
  <types>
     <xs:schema targetNamespace="http://ci.uchicago.edu/swift/2009/02/swiftscript" xmlns="http://ci.uchicago.edu/swift/2009/02/swiftscript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xs="http://www.w3.org/2001/XMLSchema">
      	   <xs:simpleType name="file">
      	   <xs:restriction base="string"/>
      	   </xs:simpleType>
      	   <xs:simpleType name="perlscript">
      	   <xs:restriction base="string"/>
      	   </xs:simpleType>
     </xs:schema>
  </types>
  <global name="swift#string#17002">
    <vdl:new type="string" value="Indir" />
  </global>
  <global name="swift#string#17003">
    <vdl:new type="string" value="./input/" />
  </global>
  <global name="swift#string#17000">
    <vdl:new type="string" value="nfiles" />
  </global>
  <global name="swift#string#17007">
    <vdl:new type="string" value=".out" />
  </global>
  <global name="swift#string#17005">
    <vdl:new type="string" value=".inp" />
  </global>
  <global name="swift#string#17001">
    <vdl:new type="string" value="1000" />
  </global>
  <element name="do__sum" arguments="output,input,ps" _defline="6">
     
     
     
    <unitStart name="do__sum" line="6" type="PROCEDURE" outputs="output"/>
    <vdl:execute>
      <vdl:tr>perl</vdl:tr>
      <vdl:stagein var="{input}"/>
      <vdl:stagein var="{ps}"/>
      <vdl:stageout var="{output}"/>

      <vdl:arguments>
        <swiftscript:filename _traceline="8">
         <variable>ps</variable> 
        </swiftscript:filename>
        <swiftscript:filename _traceline="8">
         <variable>input</variable> 
        </swiftscript:filename>
      </vdl:arguments>
      <vdl:stdout>
        <swiftscript:filename _traceline="8">
         <variable>output</variable> 
        </swiftscript:filename>
      </vdl:stdout>
    </vdl:execute>
    <vdl:closedataset var="{output}"/>
    <unitEnd name="do__sum" line="6" type="PROCEDURE"/></element>

  <set name="sumall_pl">
        <vdl:new type="perlscript" dbgname="sumall_pl" _defline="4" input="true">
          <vdl:mapping descriptor="single_file_mapper">
            <vdl:parameter name="file" value="sumall.pl"/>
          </vdl:mapping>
        </vdl:new>
  </set>
   
  <set name="nFiles">
        <vdl:new type="int" dbgname="nFiles" waitCount="1" _defline="12"/>
  </set>
   
  <set name="Indir">
        <vdl:new type="string" dbgname="Indir" waitCount="1" _defline="13"/>
  </set>
   
  <set name="swift#mapper#17004">
        <vdl:new type="string" dbgname="swift#mapper#17004" _defline=""/>
  </set>
   
  <set name="inputs">
    <vdl:new type="file[]" dbgname="inputs" _defline="16" input="true">
      <vdl:mapping descriptor="filesys_mapper">
        <vdl:parameter name="location"><variable>Indir</variable></vdl:parameter>
        <vdl:parameter name="suffix"><vdl:new type="string" value=".inp" /></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <set name="swift#mapper#17006">
        <vdl:new type="string" dbgname="swift#mapper#17006" _defline=""/>
  </set>
   
  <set name="outputs">
    <vdl:new type="file[]" dbgname="outputs" waitCount="1" _defline="17">
      <vdl:mapping descriptor="simple_mapper">
        <vdl:parameter name="location"><variable>Indir</variable></vdl:parameter>
        <vdl:parameter name="suffix"><vdl:new type="string" value=".out" /></vdl:parameter>
      </vdl:mapping>
    </vdl:new>
  </set>
   
  <restartLog>
  	<vdl:mains>
		<vdl:startprogressticker />
		<vdl:mainp>
		    <uparallel>
		        <sequential>
		             <vdl:setfieldvalue _traceline="13">
		                 <variable>nFiles</variable>
		                 <swiftscript:to_int _traceline="12">
		                  <swiftscript:arg _traceline="12">
		                  <variable>swift#string#17000</variable><variable>swift#string#17001</variable> 
		                 </swiftscript:arg> 
		                 </swiftscript:to_int>
		             </vdl:setfieldvalue>
		             <partialCloseDataset var="{nFiles}"/>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="16">
		                 <variable>Indir</variable>
		                 <swiftscript:arg _traceline="13">
		                  <variable>swift#string#17002</variable><variable>swift#string#17003</variable> 
		                 </swiftscript:arg>
		             </vdl:setfieldvalue>
		             <partialCloseDataset var="{Indir}"/>
		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17004</variable>
		                 <variable>swift#string#17005</variable>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		             <vdl:setfieldvalue _traceline="-1">
		                 <variable>swift#mapper#17006</variable>
		                 <variable>swift#string#17007</variable>
		             </vdl:setfieldvalue>

		        </sequential>
		        <sequential>
		          <vdl:tparallelFor name="$"_kvar="i" _vvar="input" refs="outputs 1">
		          	<getarrayiterator>
		          		<variable>inputs</variable>
		          	</getarrayiterator>
		          	<set names="$$, input">
		          		<each items="{$}"/>
		          	</set>
		          	<set name="i">
		          		<vdl:new type="int" value="{$$}"/>
		          	</set>
		          	<unitStart line="19" type="FOREACH_IT"/>
		          	<sequentialWithID>
		          	    <sequential>
		          	      <do__sum _traceline="20">
		          	          <vdl:getfieldsubscript>
		          	            <argument name="var"><variable>outputs</variable></argument>
		          	            <argument name="subscript"><variable>i</variable></argument>
		          	          </vdl:getfieldsubscript>
		          	          <variable>input</variable>
		          	          <variable>sumall_pl</variable>
		          	      </do__sum>
		          	      <partialCloseDataset var="{outputs}"/>
		          	    </sequential>
		          	</sequentialWithID>
		          	<unitEnd line="19" type="FOREACH_IT"/>
		          </vdl:tparallelFor>
		        </sequential>
		    </uparallel>
		</vdl:mainp>
		<vdl:stopprogressticker />
	</vdl:mains>
  </restartLog>
  <vdl:cleandataset var="{inputs}"/>
  <vdl:cleandataset var="{outputs}"/>
  <vdl:cleandataset var="{sumall_pl}"/>
  <vdl:cleandataset shutdown="true"/>
</project>
